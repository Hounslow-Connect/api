{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Create the infrastructure needed to run the One Hounslow Connect API",
    "Outputs": {
        "DatabaseHost": {
            "Description": "The host of the RDS instance",
            "Value": {
                "Fn::GetAtt": [
                    "Database",
                    "Endpoint.Address"
                ]
            }
        },
        "DatabaseName": {
            "Description": "The database name",
            "Value": "one_hounslow_connect"
        },
        "DatabasePort": {
            "Description": "The port of the RDS instance",
            "Value": {
                "Fn::GetAtt": [
                    "Database",
                    "Endpoint.Port"
                ]
            }
        },
        "DatabaseUsername": {
            "Description": "The username for the database",
            "Value": "one_hounslow_connect"
        },
        "DefaultQueue": {
            "Description": "The name of the default queue",
            "Value": {
                "Fn::Join": [
                    "-",
                    [
                        {
                            "Ref": "Environment"
                        },
                        {
                            "Ref": "Uuid"
                        },
                        "default"
                    ]
                ]
            }
        },
        "DockerClusterName": {
            "Description": "The name of the Docker cluster",
            "Value": {
                "Ref": "ApiCluster"
            }
        },
        "DockerRepositoryUri": {
            "Description": "The URI of the Docker repository",
            "Value": {
                "Fn::Sub": [
                    "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${RepositoryName}",
                    {
                        "RepositoryName": {
                            "Ref": "DockerRepository"
                        }
                    }
                ]
            }
        },
        "ElasticsearchHost": {
            "Description": "The host of the Elasticsearch instance",
            "Value": {
                "Fn::GetAtt": [
                    "Elasticsearch",
                    "DomainEndpoint"
                ]
            }
        },
        "LoadBalancerDomain": {
            "Description": "The domain name of the load balancer",
            "Value": {
                "Fn::GetAtt": [
                    "LoadBalancer",
                    "DNSName"
                ]
            }
        },
        "NotificationsQueue": {
            "Description": "The name of the notifications queue",
            "Value": {
                "Fn::Join": [
                    "-",
                    [
                        {
                            "Ref": "Environment"
                        },
                        {
                            "Ref": "Uuid"
                        },
                        "notifications"
                    ]
                ]
            }
        },
        "RedisHost": {
            "Description": "The host of the Redis instance",
            "Value": {
                "Fn::GetAtt": [
                    "Redis",
                    "RedisEndpoint.Address"
                ]
            }
        },
        "RedisPort": {
            "Description": "The port of the Redis instance",
            "Value": {
                "Fn::GetAtt": [
                    "Redis",
                    "RedisEndpoint.Port"
                ]
            }
        }
    },
    "Parameters": {
        "ApiInstanceClass": {
            "AllowedValues": [
                "t3.nano",
                "t3.micro",
                "t3.small",
                "t3.medium",
                "t3.large",
                "t3.xlarge",
                "t3.2xlarge"
            ],
            "ConstraintDescription": "Must select a valid API instance type.",
            "Default": "t3.micro",
            "Description": "The API EC2 instance class.",
            "Type": "String"
        },
        "ApiInstanceCount": {
            "ConstraintDescription": "Must be 1 or more.",
            "Default": "2",
            "Description": "The number of API EC2 instances to load balance between.",
            "MinValue": "1",
            "Type": "Number"
        },
        "ApiTaskCount": {
            "ConstraintDescription": "Must be 0 or more.",
            "Default": "0",
            "Description": "The number of API containers to run.",
            "MinValue": "0",
            "Type": "Number"
        },
        "CertificateArn": {
            "Description": "The ARN for the API load balancer SSL certificate.",
            "Type": "String"
        },
        "DatabaseAllocatedStorage": {
            "ConstraintDescription": "Must be between 5 and 1024 GiB.",
            "Default": "10",
            "Description": "The size of the database (GiB).",
            "MaxValue": "1024",
            "MinValue": "5",
            "Type": "Number"
        },
        "DatabaseClass": {
            "AllowedValues": [
                "db.t3.micro",
                "db.t3.small",
                "db.t3.medium",
                "db.t3.large",
                "db.t3.xlarge",
                "db.t3.2xlarge"
            ],
            "ConstraintDescription": "Must select a valid database instance type.",
            "Default": "db.t3.micro",
            "Description": "The database instance class.",
            "Type": "String"
        },
        "DatabasePassword": {
            "AllowedPattern": "[a-zA-Z0-9]*",
            "ConstraintDescription": "Must only contain alphanumeric characters.",
            "Description": "The database admin password.",
            "MaxLength": "41",
            "MinLength": "8",
            "NoEcho": true,
            "Type": "String"
        },
        "ElasticsearchInstanceClass": {
            "AllowedValues": [
                "t2.small.elasticsearch",
                "t2.medium.elasticsearch"
            ],
            "ConstraintDescription": "Must select a valid Elasticsearch instance type.",
            "Default": "t2.small.elasticsearch",
            "Description": "The Elasticseach instance class.",
            "Type": "String"
        },
        "ElasticsearchInstanceCount": {
            "ConstraintDescription": "Must be 1 or more.",
            "Default": "1",
            "Description": "The number of Elasticsearch nodes to run.",
            "MinValue": "1",
            "Type": "Number"
        },
        "Environment": {
            "Description": "The environment this stack is for (e.g. production or staging).",
            "MinLength": "1",
            "Type": "String"
        },
        "QueueWorkerTaskCount": {
            "ConstraintDescription": "Must be 0 or more.",
            "Default": "0",
            "Description": "The number of queue worker containers to run.",
            "MinValue": "0",
            "Type": "Number"
        },
        "RedisNodeClass": {
            "AllowedValues": [
                "cache.t2.micro",
                "cache.t2.small",
                "cache.t2.medium"
            ],
            "ConstraintDescription": "Must select a valid Redis node type.",
            "Default": "cache.t2.micro",
            "Description": "The Redis node class.",
            "Type": "String"
        },
        "RedisNodesCount": {
            "ConstraintDescription": "Must be 1 or more.",
            "Default": "1",
            "Description": "The number of Redis nodes to have in the cluster.",
            "MinValue": "1",
            "Type": "Number"
        },
        "SchedulerTaskCount": {
            "ConstraintDescription": "Must be either 0 or 1.",
            "Default": "0",
            "Description": "The number of scheduler containers to run.",
            "MaxValue": "1",
            "MinValue": "0",
            "Type": "Number"
        },
        "Subnets": {
            "Description": "The list of subnet IDs, for at least two Availability Zones in the region in your Virtual Private Cloud (VPC).",
            "Type": "List<AWS::EC2::Subnet::Id>"
        },
        "Uuid": {
            "Default": "04b1bd58-4859-4fb7-a970-005b5a463e8d",
            "Description": "The unique ID for this stack.",
            "MaxLength": "36",
            "MinLength": "36",
            "Type": "String"
        },
        "Vpc": {
            "Description": "The Virtual Private Cloud (VPC) to launch the stack in.",
            "Type": "AWS::EC2::VPC::Id"
        }
    },
    "Resources": {
        "ApiCluster": {
            "Type": "AWS::ECS::Cluster"
        },
        "ApiLogGroup": {
            "Properties": {
                "LogGroupName": {
                    "Fn::Join": [
                        "-",
                        [
                            "api",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                },
                "RetentionInDays": 7
            },
            "Type": "AWS::Logs::LogGroup"
        },
        "ApiSecurityGroup": {
            "Properties": {
                "GroupDescription": "For connecting to the API containers",
                "SecurityGroupIngress": [
                    {
                        "Description": "Full access from the load balancer",
                        "FromPort": "0",
                        "IpProtocol": "tcp",
                        "SourceSecurityGroupName": {
                            "Ref": "LoadBalancerSecurityGroup"
                        },
                        "ToPort": "65535"
                    }
                ]
            },
            "Type": "AWS::EC2::SecurityGroup"
        },
        "ApiService": {
            "DependsOn": [
                "LoadBalancerListener"
            ],
            "Properties": {
                "Cluster": {
                    "Ref": "ApiCluster"
                },
                "DeploymentConfiguration": {
                    "MaximumPercent": 200,
                    "MinimumHealthyPercent": 100
                },
                "DesiredCount": {
                    "Ref": "ApiTaskCount"
                },
                "LaunchType": "EC2",
                "LoadBalancers": [
                    {
                        "ContainerName": "api",
                        "ContainerPort": 80,
                        "TargetGroupArn": {
                            "Ref": "ApiTargetGroup"
                        }
                    }
                ],
                "Role": {
                    "Ref": "ECSServiceRole"
                },
                "ServiceName": "api",
                "TaskDefinition": {
                    "Ref": "ApiTaskDefinition"
                }
            },
            "Type": "AWS::ECS::Service"
        },
        "ApiTargetGroup": {
            "DependsOn": [
                "LoadBalancer"
            ],
            "Properties": {
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckPath": "/",
                "HealthCheckPort": "traffic-port",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 5,
                "Port": 80,
                "Protocol": "HTTP",
                "TargetType": "instance",
                "UnhealthyThresholdCount": 2,
                "VpcId": {
                    "Ref": "Vpc"
                }
            },
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup"
        },
        "ApiTaskDefinition": {
            "Properties": {
                "ContainerDefinitions": [
                    {
                        "Essential": "true",
                        "Image": {
                            "Fn::Join": [
                                ".",
                                [
                                    {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "dkr.ecr",
                                    {
                                        "Ref": "AWS::Region"
                                    },
                                    {
                                        "Fn::Join": [
                                            "/",
                                            [
                                                "amazonaws.com",
                                                {
                                                    "Ref": "DockerRepository"
                                                }
                                            ]
                                        ]
                                    }
                                ]
                            ]
                        },
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": {
                                    "Ref": "ApiLogGroup"
                                },
                                "awslogs-region": {
                                    "Ref": "AWS::Region"
                                },
                                "awslogs-stream-prefix": "ecs"
                            }
                        },
                        "MemoryReservation": "256",
                        "Name": "api",
                        "PortMappings": [
                            {
                                "ContainerPort": "80",
                                "HostPort": "0",
                                "Protocol": "tcp"
                            }
                        ]
                    }
                ],
                "Family": {
                    "Fn::Join": [
                        "-",
                        [
                            "api",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                },
                "NetworkMode": "bridge",
                "RequiresCompatibilities": [
                    "EC2"
                ]
            },
            "Type": "AWS::ECS::TaskDefinition"
        },
        "ApiUser": {
            "Properties": {
                "Policies": [
                    {
                        "PolicyDocument": {
                            "Statement": [
                                {
                                    "Action": "s3:*",
                                    "Effect": "Allow",
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "UploadsBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Join": [
                                                "/",
                                                [
                                                    {
                                                        "Fn::GetAtt": [
                                                            "UploadsBucket",
                                                            "Arn"
                                                        ]
                                                    },
                                                    "*"
                                                ]
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "Action": "sqs:*",
                                    "Effect": "Allow",
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "DefaultQueue",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Action": "sqs:*",
                                    "Effect": "Allow",
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "NotificationsQueue",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Action": "sqs:*",
                                    "Effect": "Allow",
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "SearchQueue",
                                            "Arn"
                                        ]
                                    }
                                }
                            ],
                            "Version": "2012-10-17"
                        },
                        "PolicyName": "ApiUserPolicy"
                    }
                ],
                "UserName": {
                    "Fn::Join": [
                        "-",
                        [
                            "api",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                }
            },
            "Type": "AWS::IAM::User"
        },
        "AutoScalingGroup": {
            "Properties": {
                "AvailabilityZones": [
                    "eu-west-2a",
                    "eu-west-2b",
                    "eu-west-2c"
                ],
                "DesiredCapacity": {
                    "Ref": "ApiInstanceCount"
                },
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "LaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "LaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MaxSize": {
                    "Ref": "ApiInstanceCount"
                },
                "MinSize": {
                    "Ref": "ApiInstanceCount"
                }
            },
            "Type": "AWS::AutoScaling::AutoScalingGroup"
        },
        "CiUser": {
            "Properties": {
                "Policies": [
                    {
                        "PolicyDocument": {
                            "Statement": [
                                {
                                    "Action": "ecr:*",
                                    "Effect": "Allow",
                                    "Resource": "*"
                                },
                                {
                                    "Action": "ecs:UpdateService",
                                    "Effect": "Allow",
                                    "Resource": "*"
                                },
                                {
                                    "Action": "secretsmanager:GetSecretValue",
                                    "Effect": "Allow",
                                    "Resource": "*"
                                }
                            ],
                            "Version": "2012-10-17"
                        },
                        "PolicyName": "CiUserPolicy"
                    }
                ],
                "UserName": {
                    "Fn::Join": [
                        "-",
                        [
                            "ci-api",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                }
            },
            "Type": "AWS::IAM::User"
        },
        "Database": {
            "Properties": {
                "AllocatedStorage": {
                    "Ref": "DatabaseAllocatedStorage"
                },
                "DBInstanceClass": {
                    "Ref": "DatabaseClass"
                },
                "DBName": "one_hounslow_connect",
                "DBSubnetGroupName": {
                    "Ref": "DatabaseSubnetGroup"
                },
                "Engine": "MySQL",
                "EngineVersion": "5.7",
                "MasterUserPassword": {
                    "Ref": "DatabasePassword"
                },
                "MasterUsername": "one_hounslow_connect",
                "PubliclyAccessible": "false",
                "VPCSecurityGroups": [
                    {
                        "Fn::GetAtt": [
                            "DatabaseSecurityGroup",
                            "GroupId"
                        ]
                    }
                ]
            },
            "Type": "AWS::RDS::DBInstance"
        },
        "DatabaseSecurityGroup": {
            "Properties": {
                "GroupDescription": "For connecting to the MySQL instance",
                "SecurityGroupIngress": [
                    {
                        "Description": "MySQL access from the API containers",
                        "FromPort": "3306",
                        "IpProtocol": "tcp",
                        "SourceSecurityGroupName": {
                            "Ref": "ApiSecurityGroup"
                        },
                        "ToPort": "3306"
                    }
                ]
            },
            "Type": "AWS::EC2::SecurityGroup"
        },
        "DatabaseSubnetGroup": {
            "Properties": {
                "DBSubnetGroupDescription": "Subnets available for the RDS instance",
                "SubnetIds": {
                    "Ref": "Subnets"
                }
            },
            "Type": "AWS::RDS::DBSubnetGroup"
        },
        "DefaultQueue": {
            "Properties": {
                "QueueName": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "Environment"
                            },
                            {
                                "Ref": "Uuid"
                            },
                            "default"
                        ]
                    ]
                }
            },
            "Type": "AWS::SQS::Queue"
        },
        "DockerRepository": {
            "Properties": {
                "LifecyclePolicy": {
                    "LifecyclePolicyText": "{\"rules\":[{\"rulePriority\":1,\"description\":\"Remove untagged images older than 1 week\",\"selection\":{\"tagStatus\":\"untagged\",\"countType\":\"sinceImagePushed\",\"countUnit\":\"days\",\"countNumber\":7},\"action\":{\"type\":\"expire\"}}]}"
                },
                "RepositoryName": {
                    "Fn::Join": [
                        "-",
                        [
                            "api",
                            {
                                "Ref": "Environment"
                            },
                            {
                                "Ref": "Uuid"
                            }
                        ]
                    ]
                }
            },
            "Type": "AWS::ECR::Repository"
        },
        "EC2InstanceProfile": {
            "Properties": {
                "Roles": [
                    {
                        "Ref": "ECSClusterRole"
                    }
                ]
            },
            "Type": "AWS::IAM::InstanceProfile"
        },
        "ECSClusterRole": {
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role"
                ]
            },
            "Type": "AWS::IAM::Role"
        },
        "ECSServiceRole": {
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs.amazonaws.com"
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "Policies": [
                    {
                        "PolicyDocument": {
                            "Statement": [
                                {
                                    "Action": [
                                        "ec2:AttachNetworkInterface",
                                        "ec2:CreateNetworkInterface",
                                        "ec2:CreateNetworkInterfacePermission",
                                        "ec2:DeleteNetworkInterface",
                                        "ec2:DeleteNetworkInterfacePermission",
                                        "ec2:Describe*",
                                        "ec2:DetachNetworkInterface",
                                        "elasticloadbalancing:DeregisterInstancesFromLoadBalancer",
                                        "elasticloadbalancing:DeregisterTargets",
                                        "elasticloadbalancing:Describe*",
                                        "elasticloadbalancing:RegisterInstancesWithLoadBalancer",
                                        "elasticloadbalancing:RegisterTargets",
                                        "route53:ChangeResourceRecordSets",
                                        "route53:CreateHealthCheck",
                                        "route53:DeleteHealthCheck",
                                        "route53:Get*",
                                        "route53:List*",
                                        "route53:UpdateHealthCheck",
                                        "servicediscovery:DeregisterInstance",
                                        "servicediscovery:Get*",
                                        "servicediscovery:List*",
                                        "servicediscovery:RegisterInstance",
                                        "servicediscovery:UpdateInstanceCustomHealthStatus"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": "*"
                                },
                                {
                                    "Action": [
                                        "ec2:CreateTags"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": "arn:aws:ec2:*:*:network-interface/*"
                                }
                            ]
                        },
                        "PolicyName": "ECSServiceRolePolicy"
                    }
                ]
            },
            "Type": "AWS::IAM::Role"
        },
        "Elasticsearch": {
            "Properties": {
                "AccessPolicies": {
                    "Statement": [
                        {
                            "Action": "es:*",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": "*"
                            },
                            "Resource": {
                                "Fn::Sub": [
                                    "arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${DomainName}/*",
                                    {
                                        "DomainName": {
                                            "Fn::Join": [
                                                "-",
                                                [
                                                    "search",
                                                    {
                                                        "Ref": "Environment"
                                                    }
                                                ]
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "DomainName": {
                    "Fn::Join": [
                        "-",
                        [
                            "search",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                },
                "EBSOptions": {
                    "EBSEnabled": "true",
                    "VolumeSize": 10,
                    "VolumeType": "gp2"
                },
                "ElasticsearchClusterConfig": {
                    "InstanceCount": {
                        "Ref": "ElasticsearchInstanceCount"
                    },
                    "InstanceType": {
                        "Ref": "ElasticsearchInstanceClass"
                    }
                },
                "ElasticsearchVersion": "7.9",
                "VPCOptions": {
                    "SecurityGroupIds": [
                        {
                            "Fn::GetAtt": [
                                "ElasticsearchSecurityGroup",
                                "GroupId"
                            ]
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Fn::Select": [
                                0,
                                {
                                    "Ref": "Subnets"
                                }
                            ]
                        }
                    ]
                },
                "LogPublishingOptions": {
                    "ES_APPLICATION_LOGS": {
                        "CloudWatchLogsLogGroupArn": {
                            "Fn::GetAtt": [
                                "SearchLogGroup",
                                "Arn"
                            ]
                        },
                        "Enabled": true
                    }
                }
            },
            "Type": "AWS::Elasticsearch::Domain"
        },
        "ElasticsearchCustomLogGroupPolicy": {
            "Properties": {
                "CWLOGS_ARN": {
                    "Fn::GetAtt": [
                        "SearchLogGroup",
                        "Arn"
                    ]
                },
                "CWLOGS_NAME": {
                    "Ref": {
                        "Fn::Join": [
                            "-",
                            [
                                "search",
                                {
                                    "Ref": "Environment"
                                }
                            ]
                        ]
                    }
                },
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "ElasticsearchLambdaLogGroupPolicyFunction",
                        "Arn"
                    ]
                }
            },
            "Type": "Custom::LogGroupPolicy"
        },
        "ElasticsearchLambdaLogGroupPolicyFunction": {
            "Properties": {
                "Code": {
                    "ZipFile": {
                        "Fn::Join": [
                            "",
                            [
                                "import urllib3",
                                "import json",
                                "import boto3",
                                "http = urllib3.PoolManager()",
                                "SUCCESS = \"SUCCESS\"",
                                "FAILED = \"FAILED\"",
                                "def send(event, context, responseStatus, responseData, physicalResourceId=None, noEcho=False):",
                                "    responseUrl = event['ResponseURL']",
                                "    print(responseUrl)",
                                "    responseBody = {}",
                                "    responseBody['Status'] = responseStatus",
                                "    responseBody['Reason'] = 'See the details in CloudWatch Log Stream: ' + context.log_stream_name",
                                "    responseBody['PhysicalResourceId'] = physicalResourceId or context.log_stream_name",
                                "    responseBody['StackId'] = event['StackId']",
                                "    responseBody['RequestId'] = event['RequestId']",
                                "    responseBody['LogicalResourceId'] = event['LogicalResourceId']",
                                "    responseBody['NoEcho'] = noEcho",
                                "    responseBody['Data'] = responseData",
                                "    json_responseBody = json.dumps(responseBody)",
                                "    print(\"Response body:\n\" + json_responseBody)",
                                "    headers = {",
                                "        'content-type' : '',",
                                "        'content-length' : str(len(json_responseBody))",
                                "    }",
                                "    try:",
                                "        response = http.request('PUT',responseUrl,body=json_responseBody.encode('utf-8'),headers=headers)",
                                "        print(\"Status code: \" + response.reason)",
                                "    except Exception as e:",
                                "        print(\"send(..) failed executing requests.put(..): \" + str(e))",
                                "def handler(event, context):",
                                "    logsgroup_policy_name=event['ResourceProperties']['CWLOGS_NAME']",
                                "    cw_log_group_arn=event['ResourceProperties']['CWLOG_ARN']",
                                "    cwlogs = boto3.client('logs')",
                                "    loggroup_policy={",
                                "        \"Version\": \"2012-10-17\",",
                                "        \"Statement\": [{",
                                "        \"Sid\": \"\",",
                                "        \"Effect\": \"Allow\",",
                                "        \"Principal\": { \"Service\": \"es.amazonaws.com\"},",
                                "        \"Action\":[",
                                "        \"logs:PutLogEvents\",",
                                "        \"logs:PutLogEventsBatch\",",
                                "        \"logs:CreateLogStream\"",
                                "            ],",
                                "        'Resource': f'{cw_log_group_arn}'",
                                "        }]",
                                "        }",
                                "    loggroup_policy = json.dumps(loggroup_policy)",
                                "    if(event['RequestType'] == 'Delete'):",
                                "        print(\"Request Type:\",event['RequestType'])",
                                "        cwlogs.delete_resource_policy(",
                                "        policyName=logsgroup_policy_name",
                                "        )",
                                "        responseData={}",
                                "        send(event, context, SUCCESS, responseData)",
                                "    elif(event['RequestType'] == 'Create'):",
                                "        try:",
                                "            cwlogs.put_resource_policy(",
                                "            policyName = logsgroup_policy_name,",
                                "            policyDocument = loggroup_policy",
                                "            )",
                                "            responseData={}",
                                "            print(\"Sending response to custom resource\")",
                                "            send(event, context, SUCCESS, responseData)",
                                "        except Exception as  e:",
                                "            print('Failed to process:', e)",
                                "            send(event, context, FAILED, responseData)",
                                "    elif(event['RequestType'] == 'Update'):",
                                "        try:",
                                "            responseData={}",
                                "            print(\"Update is not supported on this resource\")",
                                "            send(event, context, SUCCESS, responseData)",
                                "        except Exception as  e:",
                                "            print('Failed to process:', e)",
                                "            send(event, context, FAILED, responseData)"
                            ]
                        ]
                    }
                },
                "FunctionName": {
                    "Ref": {
                        "Fn::Join": [
                            "-",
                            [
                                "search",
                                "lambda",
                                {
                                    "Ref": "Environment"
                                }
                            ]
                        ]
                    }
                },
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Runtime": "python3.6"
            },
            "Type": "AWS::Lambda::Function"
        },
        "ElasticsearchSecurityGroup": {
            "Properties": {
                "GroupDescription": "For connecting to the Elasticsearch service",
                "SecurityGroupIngress": [
                    {
                        "Description": "HTTPS access from the API containers",
                        "FromPort": "443",
                        "IpProtocol": "tcp",
                        "SourceSecurityGroupName": {
                            "Ref": "ApiSecurityGroup"
                        },
                        "ToPort": "443"
                    }
                ]
            },
            "Type": "AWS::EC2::SecurityGroup"
        },
        "LambdaExecutionRole": {
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "Policies": [
                    {
                        "PolicyDocument": {
                            "Statement": [
                                {
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": {
                                        "Fn::Sub": [
                                            "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${LambdaFunctionName}:log-stream:*",
                                            {
                                                "LambdaFunctionName": {
                                                    "Fn::Join": [
                                                        "-",
                                                        [
                                                            "search",
                                                            "lambda",
                                                            {
                                                                "Ref": "Environment"
                                                            }
                                                        ]
                                                    ]
                                                }
                                            }
                                        ]
                                    }
                                }
                            ]
                        },
                        "PolicyName": "LambdaExecutionRoleCreateLogStreamPolicy"
                    },
                    {
                        "PolicyDocument": {
                            "Statement": [
                                {
                                    "Action": [
                                        "logs:CreateLogGroup"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": [
                                        {
                                            "Fn::Sub": [
                                                "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${LambdaFunctionName}:log-stream:*",
                                                {
                                                    "LambdaFunctionName": {
                                                        "Fn::Join": [
                                                            "-",
                                                            [
                                                                "search",
                                                                "lambda",
                                                                {
                                                                    "Ref": "Environment"
                                                                }
                                                            ]
                                                        ]
                                                    }
                                                }
                                            ]
                                        },
                                        {
                                            "Fn::Sub": [
                                                "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${LogGroupName}:log-stream:*",
                                                {
                                                    "LogGroupName": {
                                                        "Fn::Join": [
                                                            "-",
                                                            [
                                                                "search",
                                                                {
                                                                    "Ref": "Environment"
                                                                }
                                                            ]
                                                        ]
                                                    }
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "Action": [
                                        "logs:PutResourcePolicy",
                                        "logs:DeleteResourcePolicy"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
                                    }
                                }
                            ]
                        },
                        "PolicyName": "LambdaExecutionRoleCreateLogGroupPolicy"
                    }
                ]
            },
            "Type": "AWS::IAM::Role"
        },
        "LaunchTemplate": {
            "Properties": {
                "LaunchTemplateData": {
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvdcz",
                            "Ebs": {
                                "DeleteOnTermination": "true",
                                "VolumeSize": 22,
                                "VolumeType": "gp2"
                            }
                        }
                    ],
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "EC2InstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "ImageId": "ami-0f82969826859fb14",
                    "InstanceInitiatedShutdownBehavior": "terminate",
                    "InstanceType": {
                        "Ref": "ApiInstanceClass"
                    },
                    "Monitoring": {
                        "Enabled": "true"
                    },
                    "SecurityGroups": [
                        {
                            "Ref": "ApiSecurityGroup"
                        }
                    ],
                    "UserData": {
                        "Fn::Base64": {
                            "Fn::Join": [
                                "",
                                [
                                    "#!/bin/bash\n",
                                    "echo ECS_CLUSTER=",
                                    {
                                        "Ref": "ApiCluster"
                                    },
                                    " >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;"
                                ]
                            ]
                        }
                    }
                },
                "LaunchTemplateName": {
                    "Fn::Join": [
                        "-",
                        [
                            "api-launch-template",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                }
            },
            "Type": "AWS::EC2::LaunchTemplate"
        },
        "LoadBalancer": {
            "Properties": {
                "Scheme": "internet-facing",
                "SecurityGroups": [
                    {
                        "Fn::GetAtt": [
                            "LoadBalancerSecurityGroup",
                            "GroupId"
                        ]
                    }
                ],
                "Subnets": {
                    "Ref": "Subnets"
                }
            },
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer"
        },
        "LoadBalancerListener": {
            "Properties": {
                "Certificates": [
                    {
                        "CertificateArn": {
                            "Ref": "CertificateArn"
                        }
                    }
                ],
                "DefaultActions": [
                    {
                        "TargetGroupArn": {
                            "Ref": "ApiTargetGroup"
                        },
                        "Type": "forward"
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "LoadBalancer"
                },
                "Port": 443,
                "Protocol": "HTTPS"
            },
            "Type": "AWS::ElasticLoadBalancingV2::Listener"
        },
        "LoadBalancerSecurityGroup": {
            "Properties": {
                "GroupDescription": "For connecting to the API load balancer",
                "SecurityGroupIngress": [
                    {
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTP access from the public",
                        "FromPort": "80",
                        "IpProtocol": "tcp",
                        "ToPort": "80"
                    },
                    {
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTPS access from the public",
                        "FromPort": "443",
                        "IpProtocol": "tcp",
                        "ToPort": "443"
                    }
                ]
            },
            "Type": "AWS::EC2::SecurityGroup"
        },
        "NotificationsQueue": {
            "Properties": {
                "QueueName": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "Environment"
                            },
                            {
                                "Ref": "Uuid"
                            },
                            "notifications"
                        ]
                    ]
                }
            },
            "Type": "AWS::SQS::Queue"
        },
        "QueueWorkerLogGroup": {
            "Properties": {
                "LogGroupName": {
                    "Fn::Join": [
                        "-",
                        [
                            "queue-worker",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                },
                "RetentionInDays": 7
            },
            "Type": "AWS::Logs::LogGroup"
        },
        "QueueWorkerService": {
            "Properties": {
                "Cluster": {
                    "Ref": "ApiCluster"
                },
                "DeploymentConfiguration": {
                    "MaximumPercent": 100,
                    "MinimumHealthyPercent": 0
                },
                "DesiredCount": {
                    "Ref": "QueueWorkerTaskCount"
                },
                "LaunchType": "EC2",
                "ServiceName": "queue-worker",
                "TaskDefinition": {
                    "Ref": "QueueWorkerTaskDefinition"
                }
            },
            "Type": "AWS::ECS::Service"
        },
        "QueueWorkerTaskDefinition": {
            "Properties": {
                "ContainerDefinitions": [
                    {
                        "Command": [
                            "php",
                            "artisan",
                            "queue:work",
                            "--tries=1",
                            "--queue=default,notifications,search"
                        ],
                        "Essential": "true",
                        "HealthCheck": {
                            "Command": [
                                "CMD-SHELL",
                                "php -v || exit 1"
                            ],
                            "Interval": 30,
                            "Retries": 3,
                            "Timeout": 5
                        },
                        "Image": {
                            "Fn::Join": [
                                ".",
                                [
                                    {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "dkr.ecr",
                                    {
                                        "Ref": "AWS::Region"
                                    },
                                    {
                                        "Fn::Join": [
                                            "/",
                                            [
                                                "amazonaws.com",
                                                {
                                                    "Ref": "DockerRepository"
                                                }
                                            ]
                                        ]
                                    }
                                ]
                            ]
                        },
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": {
                                    "Ref": "QueueWorkerLogGroup"
                                },
                                "awslogs-region": {
                                    "Ref": "AWS::Region"
                                },
                                "awslogs-stream-prefix": "ecs"
                            }
                        },
                        "MemoryReservation": "256",
                        "Name": "api",
                        "WorkingDirectory": "/var/www/html"
                    }
                ],
                "Family": {
                    "Fn::Join": [
                        "-",
                        [
                            "queue-worker",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                },
                "NetworkMode": "bridge",
                "RequiresCompatibilities": [
                    "EC2"
                ]
            },
            "Type": "AWS::ECS::TaskDefinition"
        },
        "Redis": {
            "Properties": {
                "CacheNodeType": {
                    "Ref": "RedisNodeClass"
                },
                "CacheSubnetGroupName": {
                    "Ref": "RedisSubnetGroup"
                },
                "Engine": "redis",
                "EngineVersion": "4.0",
                "NumCacheNodes": {
                    "Ref": "RedisNodesCount"
                },
                "VpcSecurityGroupIds": [
                    {
                        "Fn::GetAtt": [
                            "RedisSecurityGroup",
                            "GroupId"
                        ]
                    }
                ]
            },
            "Type": "AWS::ElastiCache::CacheCluster"
        },
        "RedisSecurityGroup": {
            "Properties": {
                "GroupDescription": "For connecting to the Redis cluster",
                "SecurityGroupIngress": [
                    {
                        "Description": "Redis access from the API containers",
                        "FromPort": "6379",
                        "IpProtocol": "tcp",
                        "SourceSecurityGroupName": {
                            "Ref": "ApiSecurityGroup"
                        },
                        "ToPort": "6379"
                    }
                ]
            },
            "Type": "AWS::EC2::SecurityGroup"
        },
        "RedisSubnetGroup": {
            "Properties": {
                "Description": "Subnets available for the Redis cluster",
                "SubnetIds": {
                    "Ref": "Subnets"
                }
            },
            "Type": "AWS::ElastiCache::SubnetGroup"
        },
        "SchedulerLogGroup": {
            "Properties": {
                "LogGroupName": {
                    "Fn::Join": [
                        "-",
                        [
                            "scheduler",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                },
                "RetentionInDays": 7
            },
            "Type": "AWS::Logs::LogGroup"
        },
        "SchedulerService": {
            "Properties": {
                "Cluster": {
                    "Ref": "ApiCluster"
                },
                "DeploymentConfiguration": {
                    "MaximumPercent": 100,
                    "MinimumHealthyPercent": 0
                },
                "DesiredCount": {
                    "Ref": "SchedulerTaskCount"
                },
                "LaunchType": "EC2",
                "ServiceName": "scheduler",
                "TaskDefinition": {
                    "Ref": "SchedulerTaskDefinition"
                }
            },
            "Type": "AWS::ECS::Service"
        },
        "SchedulerTaskDefinition": {
            "Properties": {
                "ContainerDefinitions": [
                    {
                        "Command": [
                            "php",
                            "artisan",
                            "ck:run-scheduler"
                        ],
                        "Essential": "true",
                        "HealthCheck": {
                            "Command": [
                                "CMD-SHELL",
                                "php -v || exit 1"
                            ],
                            "Interval": 30,
                            "Retries": 3,
                            "Timeout": 5
                        },
                        "Image": {
                            "Fn::Join": [
                                ".",
                                [
                                    {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "dkr.ecr",
                                    {
                                        "Ref": "AWS::Region"
                                    },
                                    {
                                        "Fn::Join": [
                                            "/",
                                            [
                                                "amazonaws.com",
                                                {
                                                    "Fn::Join": [
                                                        "-",
                                                        [
                                                            "api",
                                                            {
                                                                "Ref": "Environment"
                                                            },
                                                            {
                                                                "Ref": "Uuid"
                                                            }
                                                        ]
                                                    ]
                                                }
                                            ]
                                        ]
                                    }
                                ]
                            ]
                        },
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": {
                                    "Ref": "SchedulerLogGroup"
                                },
                                "awslogs-region": {
                                    "Ref": "AWS::Region"
                                },
                                "awslogs-stream-prefix": "ecs"
                            }
                        },
                        "MemoryReservation": "256",
                        "Name": "api",
                        "WorkingDirectory": "/var/www/html"
                    }
                ],
                "Family": {
                    "Fn::Join": [
                        "-",
                        [
                            "scheduler",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                },
                "NetworkMode": "bridge",
                "RequiresCompatibilities": [
                    "EC2"
                ]
            },
            "Type": "AWS::ECS::TaskDefinition"
        },
        "SearchLambdaLogGroup": {
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": [
                        "/aws/lambda/${LambdaFunctionName}",
                        {
                            "LambdaFunctionName": {
                                "Fn::Join": [
                                    "-",
                                    [
                                        "search",
                                        "lambda",
                                        {
                                            "Ref": "Environment"
                                        }
                                    ]
                                ]
                            }
                        }
                    ]
                },
                "RetentionInDays": 7
            },
            "Type": "AWS::Logs::LogGroup"
        },
        "SearchLogGroup": {
            "Properties": {
                "LogGroupName": {
                    "Fn::Join": [
                        "-",
                        [
                            "search",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                },
                "RetentionInDays": 7
            },
            "Type": "AWS::Logs::LogGroup"
        },
        "SearchQueue": {
            "Properties": {
                "QueueName": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "Environment"
                            },
                            {
                                "Ref": "Uuid"
                            },
                            "search"
                        ]
                    ]
                }
            },
            "Type": "AWS::SQS::Queue"
        },
        "UploadsBucket": {
            "Properties": {
                "AccessControl": "Private",
                "BucketName": {
                    "Fn::Join": [
                        "-",
                        [
                            "uploads",
                            {
                                "Ref": "Environment"
                            },
                            {
                                "Ref": "Uuid"
                            }
                        ]
                    ]
                }
            },
            "Type": "AWS::S3::Bucket"
        }
    }
}
